@model FMS2.Models.FileResultModel
@using System.IO
@using Microsoft.Extensions.FileProviders
@{
    ViewData["Title"] = "Browse";
    object lastPath = ViewData["path"];
    object msg = TempData["returnMessage"];
    var returnUrl = ViewData["returnUrl"];
}

<h3>
    Directory listing for:
</h3>

<span>
    @{
        string[] splitted = lastPath.ToString().Split("/");
        string last = "";
        var tmp = Context.Request.Host + "/File?path=" + last;

        <a href="/File?path">Index</a>
        <label>/</label>
        foreach (string part in splitted)
        {

            if (!String.IsNullOrEmpty(part))
            {

                last = String.Concat(last, "/", part);
                tmp = Context.Request.Host + "/File?path=" + last;
                <a href=@tmp>@part</a>
                <label>/</label>
            }
        }
    }

    <input id="helperInput" value=@tmp class="offscreen" aria-hidden="true" />
    <button class="btn btn-primary-outline" id="copyButton" onclick="copyToClipboard('helperInput');" type="button"><i class="fas fa-copy"></i></button>

</span>

@await Html.PartialAsync("_StatusMessage", msg)

<div id="download-panel" class="row" hidden>
    @await Html.PartialAsync("_DownloadPartial")
</div>

<div class="row">
    <span class="manage-span">
        <input id="searchBox" type="text" oninput="searchFileList();" placeholder="Search list..." class="form-control" />
        <a asp-controller="File" asp-action="Index" asp-route-path="@returnUrl"><i class="fas fa-arrow-left"></i></a>
    </span>
</div>
<div class="d-flex align-items-center text-center align-content-center row" style="padding-top: 10px; padding-bottom: 10px; font-weight: bold;">
    <div class="col-md-4">
        Name
    </div>
    <div class="col-md-4">
        Size
    </div>
    <div class="col-md-4">
        Options
    </div>
</div>
<div id="file-list" class="d-flex align-items-center text-center align-content-center div-table">
    @{
        if (Model.Contents != null && Model.Contents.Count > 0)
        {
            foreach (IFileInfo item in Model.Contents)
            {
                <div class="row">
                    <div class="col-md-4 truncate">
                        @if (item.IsDirectory)
                        {
                            <i class="fas fa-folder"></i>
                            <a asp-controller="File" asp-action="Index" asp-route-path=@item.Name>@item.Name</a>
                        }
                        else
                        {
                            var type = MIMEAssistant.RecognizeIconByMime(MIMEAssistant.GetMIMEType(item.Name));
                            <i class="fas fa-@type"></i>
                            <a asp-controller="File" asp-action="Download" asp-route-id=@item.Name>@item.Name</a>
                        }
                    </div>
                    <div class="col-md-4">
                        @if (!item.IsDirectory)
                        {
                            var unitStrPart = "";
                            long i = item.Length;
                            string[] units = { "B", "kB", "MB", "GB", "TB" };
                            int unitIndex = 0;
                            for (int ptr = 0; ptr <= units.Length; ptr++)
                            {
                                if (i < Math.Pow(1024, ptr) && i > 1024)
                                {
                                    unitIndex = ptr - 1;
                                    break;
                                }
                            }
                            unitStrPart = Math.Round(i / Math.Pow(1024, unitIndex), 2) + " " + units[unitIndex];
                            <p>@unitStrPart</p>
                        }
                        else
                        {
                            <p>---</p>
                        }
                    </div>
                    <div class="col-md-4 opt-font">
                        @if (!item.IsDirectory) { 

                            var systemPath = lastPath + "/" + item.Name;
                            <a href="GenerateUrlView?name=@systemPath&returnUrl=@Context.Request.Path"><i class="fas fa-bolt" title="Generate download url"></i></a>
                        }

                    </div>
                </div>
                <hr>
            }
        }
        else
        {
            <div class="row">
                <h1>It is empty in here...</h1>
            </div>
        }
    }
</div>
<div class="row">
    <a asp-controller="File" asp-action="Index" asp-route-path=@returnUrl><i class="fas fa-arrow-left"></i></a>
</div>
<script>
    document.getElementById("searchBox").addEventListener("keydown", function (e) {
        if (e.keyCode == 8) {
            searchFileList();
        }
    });
</script>